<!DOCTYPE html>
<html>
<head>
    <title>Current Deployment Testing - Histofy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { margin: 5px; padding: 10px; }
        .results { margin: 10px 0; padding: 10px; background: #f9f9f9; }
        .log { font-family: monospace; font-size: 12px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Current Deployment Flow Testing</h1>
    
    <div class="test-section">
        <h2>Environment Check</h2>
        <div id="environment-results"></div>
        <button onclick="checkEnvironment()">Check Environment</button>
    </div>

    <div class="test-section">
        <h2>Mock Deployment Test</h2>
        <div id="deployment-results"></div>
        <button onclick="testCurrentDeployment()">Test Current Deployment</button>
    </div>

    <div class="test-section">
        <h2>Deployment Error Simulation</h2>
        <div id="error-results"></div>
        <button onclick="simulateDeploymentErrors()">Simulate Common Errors</button>
    </div>

    <div class="test-section">
        <h2>Storage & Changes Check</h2>
        <div id="storage-results"></div>
        <button onclick="checkStorageAndChanges()">Check Storage & Changes</button>
    </div>

    <!-- Load required scripts -->
    <script src="/storage/local-storage-manager.js"></script>
    <script src="/api/github-api.js"></script>
    <script src="/api/github-deployer.js"></script>
    <script src="/ui-components/deploy-button.js"></script>

    <script>
        let testResults = [];

        function log(level, message) {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            testResults.push(logEntry);
            console.log(logEntry);
            return logEntry;
        }

        function displayResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = results.map(result => 
                `<div class="log ${result.includes('[ERROR]') ? 'fail' : result.includes('[WARNING]') ? 'warning' : result.includes('[INFO]') ? 'info' : 'pass'}">${result}</div>`
            ).join('');
        }

        async function checkEnvironment() {
            const results = [];
            
            try {
                // Check if all required classes are available
                if (typeof GitHubAPI !== 'undefined') {
                    results.push(log('pass', 'GitHubAPI class is available'));
                } else {
                    results.push(log('error', 'GitHubAPI class is NOT available'));
                }

                if (typeof GitHubDeployer !== 'undefined') {
                    results.push(log('pass', 'GitHubDeployer class is available'));
                } else {
                    results.push(log('error', 'GitHubDeployer class is NOT available'));
                }

                if (typeof DeployButton !== 'undefined') {
                    results.push(log('pass', 'DeployButton class is available'));
                } else {
                    results.push(log('error', 'DeployButton class is NOT available'));
                }

                if (window.histofyStorage) {
                    results.push(log('pass', 'Storage manager is available'));
                } else {
                    results.push(log('error', 'Storage manager is NOT available'));
                }

                // Check if deploy button is initialized
                if (window.histofyDeployButton) {
                    results.push(log('pass', 'Deploy button instance exists'));
                } else {
                    results.push(log('error', 'Deploy button instance does NOT exist'));
                }

                // Check environment state
                results.push(log('info', `Current URL: ${window.location.href}`));
                results.push(log('info', `Document ready state: ${document.readyState}`));

            } catch (error) {
                results.push(log('error', `Environment check failed: ${error.message}`));
            }

            displayResults('environment-results', results);
        }

        async function testCurrentDeployment() {
            const results = [];
            
            try {
                results.push(log('info', 'Starting current deployment test...'));

                // Step 1: Initialize GitHub API
                let githubAPI = null;
                try {
                    githubAPI = new GitHubAPI();
                    await githubAPI.init();
                    results.push(log('pass', 'GitHub API initialized successfully'));
                } catch (error) {
                    results.push(log('error', `GitHub API initialization failed: ${error.message}`));
                    displayResults('deployment-results', results);
                    return;
                }

                // Step 2: Initialize GitHub Deployer
                let deployer = null;
                try {
                    deployer = new GitHubDeployer(githubAPI);
                    results.push(log('pass', 'GitHub Deployer initialized successfully'));
                } catch (error) {
                    results.push(log('error', `GitHub Deployer initialization failed: ${error.message}`));
                    displayResults('deployment-results', results);
                    return;
                }

                // Step 3: Test essential methods
                try {
                    // Test log method
                    deployer.log('info', 'Test log message');
                    results.push(log('pass', 'log() method works'));

                    // Test updateStatus method
                    deployer.updateStatus('Test status', 50);
                    results.push(log('pass', 'updateStatus() method works'));

                    // Test groupChangesByRepository method
                    const mockChanges = [{
                        id: 'test1',
                        type: 'date_selection',
                        dates: ['2024-01-01'],
                        contributions: { '2024-01-01': { level: 2, name: 'Medium' } }
                    }];
                    const mockTarget = { owner: 'testuser', repo: 'testrepo' };
                    const grouped = deployer.groupChangesByRepository(mockChanges, mockTarget);
                    results.push(log('pass', `groupChangesByRepository() works: ${Object.keys(grouped).length} repositories`));

                } catch (error) {
                    results.push(log('error', `Method testing failed: ${error.message}`));
                }

                // Step 4: Test deployment with mock data (without actual API calls)
                try {
                    const mockPendingChanges = [
                        {
                            id: 'test-change-1',
                            type: 'date_selection',
                            dates: ['2024-01-01', '2024-01-02'],
                            contributions: {
                                '2024-01-01': { level: 1, name: 'Low' },
                                '2024-01-02': { level: 2, name: 'Medium' }
                            },
                            username: 'testuser',
                            year: 2024,
                            timestamp: Date.now()
                        }
                    ];

                    const mockOptions = {
                        targetRepository: 'testuser/histofy-contributions',
                        createIfNotExists: true,
                        private: false,
                        description: 'Test deployment'
                    };

                    results.push(log('info', 'Testing deployment preparation...'));
                    
                    // Test the deployment status initialization
                    const initialStatus = deployer.getDeploymentStatus();
                    results.push(log('pass', `Initial deployment status: isDeploying=${initialStatus.isDeploying}`));

                    // Test target repository determination
                    const targetRepo = deployer.determineTargetRepository(mockOptions);
                    results.push(log('pass', `Target repository determined: ${targetRepo.owner}/${targetRepo.repo}`));

                    // Test change grouping
                    const changesByRepo = deployer.groupChangesByRepository(mockPendingChanges, targetRepo);
                    results.push(log('pass', `Changes grouped by repository: ${Object.keys(changesByRepo).length} repos`));

                    results.push(log('info', 'Deployment preparation successful!'));

                } catch (error) {
                    results.push(log('error', `Deployment preparation failed: ${error.message}`));
                }

            } catch (error) {
                results.push(log('error', `Overall deployment test failed: ${error.message}`));
            }

            displayResults('deployment-results', results);
        }

        async function simulateDeploymentErrors() {
            const results = [];
            
            try {
                results.push(log('info', 'Simulating common deployment errors...'));

                // Test 1: Deploy button without authentication
                try {
                    if (window.histofyDeployButton) {
                        // Simulate calling startDeployment without auth
                        results.push(log('info', 'Testing deployment without authentication...'));
                        
                        // Check authentication state
                        const isAuthenticated = window.histofyDeployButton.githubAPI?.isAuthenticated();
                        if (!isAuthenticated) {
                            results.push(log('pass', 'Authentication check working - not authenticated'));
                        } else {
                            results.push(log('warning', 'User appears to be authenticated'));
                        }
                    }
                } catch (error) {
                    results.push(log('error', `Authentication test failed: ${error.message}`));
                }

                // Test 2: Deploy with no pending changes
                try {
                    results.push(log('info', 'Testing deployment with no pending changes...'));
                    
                    if (window.histofyStorage) {
                        const changes = await window.histofyStorage.getPendingChanges();
                        results.push(log('info', `Current pending changes: ${changes ? changes.length : 0}`));
                    }
                } catch (error) {
                    results.push(log('error', `Pending changes test failed: ${error.message}`));
                }

                // Test 3: GitHubDeployer method calls
                try {
                    const githubAPI = new GitHubAPI();
                    const deployer = new GitHubDeployer(githubAPI);
                    
                    // Test calling methods that might fail
                    try {
                        deployer.log('test', 'Testing log method');
                        results.push(log('pass', 'log() method call successful'));
                    } catch (error) {
                        results.push(log('error', `log() method failed: ${error.message}`));
                    }

                    try {
                        deployer.updateStatus('Test status', 25);
                        results.push(log('pass', 'updateStatus() method call successful'));
                    } catch (error) {
                        results.push(log('error', `updateStatus() method failed: ${error.message}`));
                    }

                } catch (error) {
                    results.push(log('error', `GitHubDeployer method test failed: ${error.message}`));
                }

                // Test 4: Invalid deployment options
                try {
                    results.push(log('info', 'Testing with invalid deployment options...'));
                    
                    const githubAPI = new GitHubAPI();
                    const deployer = new GitHubDeployer(githubAPI);
                    
                    // Test with null/undefined options
                    const targetRepo1 = deployer.determineTargetRepository(null);
                    results.push(log('pass', `determineTargetRepository with null options: ${targetRepo1.owner}/${targetRepo1.repo}`));
                    
                    const targetRepo2 = deployer.determineTargetRepository({});
                    results.push(log('pass', `determineTargetRepository with empty options: ${targetRepo2.owner}/${targetRepo2.repo}`));

                } catch (error) {
                    results.push(log('error', `Invalid options test failed: ${error.message}`));
                }

                results.push(log('info', 'Error simulation tests completed'));

            } catch (error) {
                results.push(log('error', `Error simulation failed: ${error.message}`));
            }

            displayResults('error-results', results);
        }

        async function checkStorageAndChanges() {
            const results = [];
            
            try {
                results.push(log('info', 'Checking storage and changes...'));

                // Test storage availability
                if (window.histofyStorage) {
                    results.push(log('pass', 'Storage manager is available'));
                    
                    try {
                        // Test getting data
                        const data = await window.histofyStorage.getData();
                        results.push(log('pass', `Storage data retrieved: ${JSON.stringify(data).length} characters`));
                        
                        // Test pending changes
                        const pendingChanges = await window.histofyStorage.getPendingChanges();
                        results.push(log('info', `Pending changes: ${pendingChanges ? pendingChanges.length : 0} items`));
                        
                        if (pendingChanges && pendingChanges.length > 0) {
                            results.push(log('info', `First change type: ${pendingChanges[0].type}`));
                            results.push(log('info', `First change has dates: ${pendingChanges[0].dates ? pendingChanges[0].dates.length : 0}`));
                        } else {
                            results.push(log('warning', 'No pending changes found in storage'));
                        }

                        // Test user settings
                        const settings = await window.histofyStorage.getUserSettings();
                        results.push(log('info', `User settings: token=${!!settings.token}, username=${settings.username || 'not set'}`));

                    } catch (error) {
                        results.push(log('error', `Storage operation failed: ${error.message}`));
                    }
                } else {
                    results.push(log('error', 'Storage manager is NOT available'));
                }

                // Test deploy button state
                if (window.histofyDeployButton) {
                    results.push(log('pass', 'Deploy button instance exists'));
                    
                    try {
                        // Check button properties
                        results.push(log('info', `isDeploying: ${window.histofyDeployButton.isDeploying}`));
                        results.push(log('info', `pendingChanges: ${window.histofyDeployButton.pendingChanges.length} items`));
                        results.push(log('info', `githubAPI: ${!!window.histofyDeployButton.githubAPI}`));
                        results.push(log('info', `githubDeployer: ${!!window.histofyDeployButton.githubDeployer}`));
                        
                        if (window.histofyDeployButton.githubAPI) {
                            const isAuth = window.histofyDeployButton.githubAPI.isAuthenticated();
                            results.push(log('info', `GitHub API authenticated: ${isAuth}`));
                        }

                    } catch (error) {
                        results.push(log('error', `Deploy button state check failed: ${error.message}`));
                    }
                } else {
                    results.push(log('error', 'Deploy button instance does NOT exist'));
                }

            } catch (error) {
                results.push(log('error', `Storage and changes check failed: ${error.message}`));
            }

            displayResults('storage-results', results);
        }

        // Auto-run environment check on load
        window.addEventListener('load', () => {
            setTimeout(checkEnvironment, 1000);
        });

    </script>
</body>
</html>
