<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Deployment Verification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-results {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .logs {
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî¨ Final Deployment Verification Test</h1>
        <p>This test verifies that all deployment fixes are working correctly and simulates a complete deployment flow.</p>
    </div>

    <div class="test-container">
        <h2>üìã Test Summary</h2>
        <div id="test-summary" class="test-section info">
            <strong>Tests to Run:</strong>
            <ul>
                <li>‚úÖ Environment & Dependencies Check</li>
                <li>‚úÖ Storage Manager Method Verification</li>
                <li>‚úÖ GitHub API & Deployer Initialization</li>
                <li>‚úÖ Deployment Flow Simulation</li>
                <li>‚úÖ Error Handling Verification</li>
            </ul>
        </div>
    </div>

    <div class="test-container">
        <h2>üèÉ‚Äç‚ôÇÔ∏è Test Execution</h2>
        <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        <button class="test-button" onclick="runDeploymentSimulation()">Simulate Deployment Only</button>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        
        <div id="test-status" class="test-section info">
            <strong>Status:</strong> Ready to run tests
        </div>
    </div>

    <div class="test-container">
        <h2>üìä Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-container">
        <h2>üìú Execution Logs</h2>
        <div id="test-logs" class="logs">Ready to start testing...</div>
    </div>

    <!-- Load required scripts -->
    <script src="storage/local-storage-manager.js"></script>
    <script src="api/github-api.js"></script>
    <script src="api/github-deployer.js"></script>
    <script src="ui-components/deploy-button.js"></script>

    <script>
        let testLogs = [];
        
        function log(message, level = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            testLogs.push(logEntry);
            
            const logsDiv = document.getElementById('test-logs');
            logsDiv.textContent = testLogs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            statusDiv.className = `test-section ${type}`;
            statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
        }

        function addTestResult(testName, passed, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = passed ? 'success' : 'error';
            const resultIcon = passed ? '‚úÖ' : '‚ùå';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${resultClass}`;
            resultDiv.innerHTML = `
                <strong>${resultIcon} ${testName}</strong>
                ${details ? `<div class="test-results">${details}</div>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function clearLogs() {
            testLogs = [];
            document.getElementById('test-logs').textContent = 'Logs cleared...';
            document.getElementById('test-results').innerHTML = '';
        }

        async function testEnvironment() {
            log('Testing environment and dependencies...');
            
            const tests = [
                { name: 'LocalStorageManager', check: () => window.LocalStorageManager },
                { name: 'GitHubAPI', check: () => window.GitHubAPI },
                { name: 'GitHubDeployer', check: () => window.GitHubDeployer },
                { name: 'DeployButton', check: () => window.histofyDeployButton },
                { name: 'histofyStorage', check: () => window.histofyStorage }
            ];

            let allPassed = true;
            for (const test of tests) {
                try {
                    const result = test.check();
                    if (result) {
                        log(`‚úÖ ${test.name} is available`);
                        addTestResult(`${test.name} Available`, true);
                    } else {
                        log(`‚ùå ${test.name} is missing`);
                        addTestResult(`${test.name} Available`, false);
                        allPassed = false;
                    }
                } catch (error) {
                    log(`‚ùå Error checking ${test.name}: ${error.message}`);
                    addTestResult(`${test.name} Available`, false, error.message);
                    allPassed = false;
                }
            }

            return allPassed;
        }

        async function testStorageMethods() {
            log('Testing storage manager methods...');
            
            if (!window.histofyStorage) {
                log('‚ùå Storage manager not available');
                addTestResult('Storage Methods', false, 'Storage manager not available');
                return false;
            }

            const methodTests = [
                'getPendingChanges',
                'clearPendingChanges', 
                'removePendingChange',
                'storePendingChange'
            ];

            let allPassed = true;
            for (const method of methodTests) {
                try {
                    if (typeof window.histofyStorage[method] === 'function') {
                        log(`‚úÖ ${method} method exists`);
                        addTestResult(`${method} method`, true);
                    } else {
                        log(`‚ùå ${method} method missing`);
                        addTestResult(`${method} method`, false);
                        allPassed = false;
                    }
                } catch (error) {
                    log(`‚ùå Error checking ${method}: ${error.message}`);
                    addTestResult(`${method} method`, false, error.message);
                    allPassed = false;
                }
            }

            // Test actual method calls
            try {
                log('Testing getPendingChanges...');
                const changes = await window.histofyStorage.getPendingChanges();
                log(`‚úÖ getPendingChanges returned: ${Array.isArray(changes) ? changes.length + ' items' : typeof changes}`);
                addTestResult('getPendingChanges execution', true, `Returned ${Array.isArray(changes) ? changes.length : 0} items`);
            } catch (error) {
                log(`‚ùå getPendingChanges failed: ${error.message}`);
                addTestResult('getPendingChanges execution', false, error.message);
                allPassed = false;
            }

            return allPassed;
        }

        async function testGitHubComponents() {
            log('Testing GitHub API and Deployer initialization...');
            
            try {
                // Test GitHubAPI initialization
                const githubAPI = new window.GitHubAPI();
                await githubAPI.init();
                log('‚úÖ GitHubAPI initialized successfully');
                addTestResult('GitHubAPI Initialization', true);

                // Test GitHubDeployer initialization
                const deployer = new window.GitHubDeployer(githubAPI);
                log('‚úÖ GitHubDeployer initialized successfully');
                addTestResult('GitHubDeployer Initialization', true);

                // Test essential deployer methods
                const deployerMethods = ['log', 'updateStatus', 'groupChangesByRepository', 'generateFileContent', 'generateCommitMessage'];
                let deployerMethodsPassed = true;
                
                for (const method of deployerMethods) {
                    if (typeof deployer[method] === 'function') {
                        log(`‚úÖ Deployer.${method} method exists`);
                    } else {
                        log(`‚ùå Deployer.${method} method missing`);
                        deployerMethodsPassed = false;
                    }
                }
                
                addTestResult('GitHubDeployer Methods', deployerMethodsPassed);
                return deployerMethodsPassed;
                
            } catch (error) {
                log(`‚ùå GitHub components test failed: ${error.message}`);
                addTestResult('GitHub Components', false, error.message);
                return false;
            }
        }

        async function simulateDeploymentFlow() {
            log('Simulating complete deployment flow...');
            
            try {
                // Create mock pending changes
                const mockChanges = [
                    {
                        id: 'test-change-1',
                        type: 'date_selection',
                        timestamp: Date.now(),
                        dates: ['2023-12-01', '2023-12-02'],
                        contributions: {
                            '2023-12-01': { level: 2, commits: 3, name: 'medium' },
                            '2023-12-02': { level: 1, commits: 1, name: 'low' }
                        }
                    }
                ];

                // Store mock changes
                log('Storing mock pending changes...');
                await window.histofyStorage.storePendingChange(mockChanges[0]);
                log('‚úÖ Mock changes stored successfully');

                // Verify storage
                const storedChanges = await window.histofyStorage.getPendingChanges();
                log(`‚úÖ Retrieved ${storedChanges.length} pending changes from storage`);

                if (storedChanges.length === 0) {
                    throw new Error('No changes found in storage after storing');
                }

                // Test deployment preparation (without actual GitHub API calls)
                const githubAPI = new window.GitHubAPI();
                await githubAPI.init();
                const deployer = new window.GitHubDeployer(githubAPI);
                
                // Test change grouping
                const groupedChanges = deployer.groupChangesByRepository(storedChanges, 'test-user/test-repo');
                log(`‚úÖ Changes grouped by repository: ${Object.keys(groupedChanges).length} repositories`);

                // Test commit message generation
                const commitMessage = deployer.generateCommitMessage(
                    '2023-12-01', 
                    1, 
                    3, 
                    { level: 2, commits: 3, name: 'medium' }
                );
                log(`‚úÖ Commit message generated: ${commitMessage.substring(0, 50)}...`);

                // Test file content generation
                const fileContent = await deployer.generateFileContent(
                    'test-user',
                    'test-repo', 
                    '2023-12-01', 
                    1, 
                    3, 
                    { level: 2, commits: 3, name: 'medium' }
                );
                log(`‚úÖ File content generated (${fileContent.length} characters)`);

                // Clear test data
                await window.histofyStorage.clearPendingChanges();
                log('‚úÖ Test data cleared');

                addTestResult('Deployment Flow Simulation', true, 'All deployment components working correctly');
                return true;

            } catch (error) {
                log(`‚ùå Deployment simulation failed: ${error.message}`);
                addTestResult('Deployment Flow Simulation', false, error.message);
                return false;
            }
        }

        async function testErrorHandling() {
            log('Testing error handling...');
            
            try {
                // Test invalid change removal
                try {
                    await window.histofyStorage.removePendingChange('non-existent-id');
                    log('‚úÖ Invalid change removal handled gracefully');
                } catch (error) {
                    log(`‚úÖ Invalid change removal threw expected error: ${error.message}`);
                }

                // Test deployer with null API
                try {
                    const badDeployer = new window.GitHubDeployer(null);
                    log('‚ö†Ô∏è Deployer accepted null API (may be intentional)');
                } catch (error) {
                    log(`‚úÖ Deployer rejected null API: ${error.message}`);
                }

                addTestResult('Error Handling', true, 'Error scenarios handled appropriately');
                return true;

            } catch (error) {
                log(`‚ùå Error handling test failed: ${error.message}`);
                addTestResult('Error Handling', false, error.message);
                return false;
            }
        }

        async function runAllTests() {
            updateStatus('Running comprehensive tests...', 'info');
            clearLogs();
            
            log('üöÄ Starting comprehensive deployment verification tests...');
            
            const testResults = [];
            
            // Run all tests
            testResults.push(await testEnvironment());
            testResults.push(await testStorageMethods());
            testResults.push(await testGitHubComponents());
            testResults.push(await simulateDeploymentFlow());
            testResults.push(await testErrorHandling());
            
            // Summary
            const passed = testResults.filter(result => result).length;
            const total = testResults.length;
            
            log(`\nüèÅ Test Summary: ${passed}/${total} test suites passed`);
            
            if (passed === total) {
                updateStatus(`All tests passed! (${passed}/${total})`, 'success');
                log('üéâ All deployment functionality is working correctly!');
            } else {
                updateStatus(`Some tests failed (${passed}/${total})`, 'error');
                log('‚ö†Ô∏è Some issues detected. Check the detailed results above.');
            }
        }

        async function runDeploymentSimulation() {
            updateStatus('Running deployment simulation...', 'info');
            clearLogs();
            
            log('üéØ Running focused deployment simulation test...');
            
            const success = await simulateDeploymentFlow();
            
            if (success) {
                updateStatus('Deployment simulation successful!', 'success');
                log('‚úÖ Deployment simulation completed successfully');
            } else {
                updateStatus('Deployment simulation failed', 'error');
                log('‚ùå Deployment simulation failed - check logs for details');
            }
        }

        // Auto-run basic environment check on page load
        window.addEventListener('load', async () => {
            log('Page loaded, running basic environment check...');
            await testEnvironment();
            updateStatus('Ready to run full tests', 'info');
        });
    </script>
</body>
</html>
